<html id="secretLang">

<head>
  <link href='../../public/styles/secret.css' rel="stylesheet">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
</head>

<body>
  <script src="/pages/lib/jquery.js"></script>
  <script src="/pages/js/ajax.js"></script>
  <script src="/pages/lib/socket.js"></script>
  <input type="image" id="backButton" onclick='AjaxCall("disable", "/")' src="../../public/images/backButton.png" />


  <div id="text"></div>
  <div id="subtext"></div>
  <span id="countdownRegister">3 </span>
  <img id="mic" src="../../public/images/mic.png" />
  <div class="progress">
    <div id="dynamic" class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar"
      aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>

  <script>

    $(document).ready(function () {
      const socket = io('http://localhost:3000');
      $("#countdownRegister").hide()

      document.getElementById('text').innerHTML = "Repeat command 8 times to register your secret language";
      document.getElementById('subtext').innerHTML = "Make your secret language sound";

      //progress bar set to 0 at start

      socket.on("secret_train", function (msg) {
        window.location.href = "./secretRegisterFinal.html";
      })

      let recurse = function (times, current_progress) {
        let socketR = io('http://localhost:3000');

        socketR.on('secret', function (msg) {

          socketR.disconnect()

          //registering your secret language
          $("#mic").hide()
          $("#countdownRegister").show()
          document.getElementById('text').innerHTML = "Registering your secret language";
          document.getElementById('subtext').innerHTML = "Loading ...";
          var seconds = document.getElementById("countdownRegister").innerHTML = 3;
          //  3 2 1 register countdown start here
          var countdown = setInterval(function () {
            seconds--;
            document.getElementById("countdownRegister").innerHTML = seconds;
            if (seconds == 1) {
              clearInterval(countdown);
            }
          }, 1000);

          //increase secret lang progress bar by 10
          setTimeout(() => {

            $("#mic").show()
            $("#countdownRegister").hide()
            current_progress += 12.8;
            times += 10;

            if ((80 - times) / 10 == 0) {

              document.getElementById('text').innerHTML = "Training ....";
              document.getElementById('subtext').innerHTML = "";
              $("#dynamic")
                .css("width", current_progress + "%")
                .attr("aria-valuenow", current_progress)

            } else {
              document.getElementById('text').innerHTML = "Repeat command " + (80 - times) / 10 + " times to register your secret language";
              document.getElementById('subtext').innerHTML = "Make your secret language sound";
              $("#dynamic")
                .css("width", current_progress + "%")
                .attr("aria-valuenow", current_progress)
            
              recurse(times, current_progress)
            }

          }, 3000)
        })

      }

      recurse(0, 0)

    })
  </script>

</body>

</html>